import S from"tiny-invariant";import{defaultTransformer as A}from"@tanstack/react-router";import b from"pino";import{drizzle as O}from"drizzle-orm/libsql";import{sql as f}from"drizzle-orm/sql";import{sqliteTable as p,integer as c,text as t}from"drizzle-orm/sqlite-core";import{sql as N,eq as _}from"drizzle-orm";function R(e,r,n){return Object.assign(e,{url:"https://localhost:3000"})}function C(e){return e instanceof Headers?new Headers(e):Array.isArray(e)?new Headers(e):typeof e=="object"?new Headers(e):new Headers}function q(...e){return e.reduce((r,n)=>{const i=C(n);for(const[o,a]of i.entries())r.set(o,a);return r},new Headers)}function g(e,r){const n=r||e||{};return typeof n.method>"u"&&(n.method="GET"),{options:n,middleware:i=>g(void 0,Object.assign(n,{middleware:i})),validator:i=>g(void 0,Object.assign(n,{validator:i})),handler:(...i)=>{const[o,a]=i;Object.assign(n,{...o,extractedFn:o,serverFn:a}),S(o.url,"createServerFn must be called with a function that is marked with the 'use server' pragma. Are you using the @tanstack/start-vite-plugin ?");const d=[...n.middleware||[],j(n)];return Object.assign(async l=>E(d,"client",{...o,method:n.method,data:l?.data,headers:l?.headers,context:Object.assign({},o)}).then(s=>s.result),{...o,__executeServer:l=>{const s=l instanceof FormData?F(l):l;return E(d,"server",{...o,...s}).then(y=>({result:y.result,context:y.sendContext}))}})}}}function F(e){const r=e.get("__TSR_CONTEXT");if(e.delete("__TSR_CONTEXT"),typeof r!="string")return{context:{},data:e};try{return{context:A.parse(r),data:e}}catch{return{data:e}}}function U(e){const r=[],n=i=>{i.forEach(o=>{o.options.middleware&&n(o.options.middleware),r.push(o)})};return n(e),r}const T=(e,r,n)=>e({data:r.data,context:r.context,sendContext:r.sendContext,method:r.method,next:i=>{const o={...r.context,...i?.context},a={...r.sendContext,...i?.sendContext??{}},d=q(r.headers,i?.headers);return n({method:r.method,data:r.data,context:o,sendContext:a,headers:d,result:i?.result??r.result})}});function I(e,r){if(e==null)return{};if("~standard"in e){const n=e["~standard"].validate(r);if(n instanceof Promise)throw new Error("Async validation not supported");if(n.issues)throw new Error(JSON.stringify(n.issues,void 0,2));return n.value}if("parse"in e)return e.parse(r);if(typeof e=="function")return e(r);throw new Error("Invalid validator type!")}async function E(e,r,n){const i=U(e),o=async a=>{const d=i.shift();if(!d)return a;d.options.validator&&(r!=="client"||d.options.validateClient)&&(a.data=await I(d.options.validator,a.data));const l=r==="client"?d.options.client:d.options.server;return l?T(l,a,async s=>{if(r==="client"&&d.options.clientAfter){const y=await o(s);return T(d.options.clientAfter,y,M=>M)}return o(s)}):o(a)};return o({...n,headers:n.headers||{},sendContext:n.sendContext||{},context:n.context||{}})}function j(e){return{_types:void 0,options:{validator:e.validator,validateClient:e.validateClient,client:async({next:r,sendContext:n,...i})=>{var o;const a=await((o=e.extractedFn)==null?void 0:o.call(e,{...i,context:n}));return r(a)},server:async({next:r,...n})=>{var i;const o=await((i=e.serverFn)==null?void 0:i.call(e,n));return r({result:o})}}}}const h=p("category",{id:c("id").primaryKey(),slug:t("slug").unique().notNull(),name:t("name").notNull(),type:t("type"),icon_path:t("icon_path"),icon_link:t("icon_link"),created_at:t("created_at").notNull().default(f`(CURRENT_TIMESTAMP)`),updated_at:t("updated_at").notNull().default(f`(CURRENT_TIMESTAMP)`).$onUpdate(()=>f`(CURRENT_TIMESTAMP)`)}),u=p("recipes",{id:c("id").primaryKey(),oid:t("oid").unique().notNull(),category_id:c("category_id").notNull().references(()=>h.id,{onDelete:"cascade"}),name:t("name").notNull(),slug:t("slug").notNull(),headline:t("headline"),description:t("description"),difficulty:t("difficulty"),prep_time:t("prep_time"),total_time:t("total_time"),image_path:t("image_path"),card_link:t("card_link"),average_rating:t("average_rating"),ratings_count:t("ratings_count"),favorites_count:t("favorites_count"),is_premium:t("is_premium"),website_url:t("website_url"),created_at:t("created_at").notNull().default(f`(CURRENT_TIMESTAMP)`),updated_at:t("updated_at").notNull().default(f`(CURRENT_TIMESTAMP)`).$onUpdate(()=>f`(CURRENT_TIMESTAMP)`)}),v=p("ingredients",{id:c("id").primaryKey(),oid:t("oid").unique().notNull(),recipe_id:c("recipe_id").notNull().references(()=>u.id,{onDelete:"cascade"}),name:t("name").notNull()}),w=p("utensils",{id:c("id").primaryKey(),oid:t("oid").unique().notNull(),recipe_id:c("recipe_id").notNull().references(()=>u.id,{onDelete:"cascade"}),name:t("name").notNull()}),m=p("steps",{id:c("id").primaryKey(),oid:t("oid").unique().notNull(),recipe_id:c("recipe_id").notNull().references(()=>u.id,{onDelete:"cascade"}),index:c("index").notNull(),instructions:t("instructions").notNull()}),k=p("images",{id:c("id").primaryKey(),oid:t("oid").unique().notNull(),step_id:c("step_id").notNull().references(()=>m.id,{onDelete:"cascade"}),link:t("link"),path:t("path"),caption:t("caption")}),H=p("timers",{id:c("id").primaryKey(),oid:t("oid").unique().notNull(),step_id:c("step_id").notNull().references(()=>m.id,{onDelete:"cascade"}),name:t("name"),duration:t("duration"),temperature:t("temperature"),temperature_unit:t("temperature_unit"),oven_mode:t("oven_mode")}),P=Object.freeze(Object.defineProperty({__proto__:null,categories:h,images:k,ingredients:v,recipes:u,steps:m,timers:H,utensils:w},Symbol.toStringTag,{value:"Module"})),x=O("file:recipes.db",{schema:P}),K=b(),D=g({method:"GET"}).handler(R(J),async()=>{K.info("fetching random recipe");const r=(await x.select({id:u.id}).from(u).where(N`(SELECT COUNT(*) FROM ingredients WHERE ingredients.recipe_id = recipes.id) > 3`).orderBy(N`RANDOM()`).limit(1))[0].id,n=await x.select().from(u).leftJoin(h,_(u.category_id,h.id)).leftJoin(m,_(u.id,m.recipe_id)).leftJoin(v,_(v.recipe_id,u.id)).leftJoin(w,_(w.recipe_id,u.id)).where(_(u.id,r)),i=n.map(s=>s.steps?.instructions),o=n.map(s=>s.ingredients?.name),a=new Set(i.filter(s=>s!==void 0)),d=new Set(o.filter(s=>s!==void 0));return{...n[0].recipes,id:void 0,steps:Array.from(a),ingredients:Array.from(d)}});function J(e){return D.__executeServer(e)}export{J as $$function0,D as fetchRandomRecipe};
